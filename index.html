<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Billets QR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tab-btn.active:hover {
            background: white;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .tab-content.active {
            display: block;
        }

        /* ONGLET SCAN */
        #scanTab {
            text-align: center;
        }

        #cameraContainer {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
        }

        #canvas {
            display: none;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            display: block;
        }

        /* ONGLET R√âSULTATS */
        .scanned-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .scanned-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .scanned-item.duplicate {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .scanned-item h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .scanned-item p {
            margin: 5px 0;
            color: #666;
            font-size: 0.95em;
        }

        .scanned-item .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-table {
            background: #667eea;
            color: white;
        }

        .badge-time {
            background: #6c757d;
            color: white;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .export-btn {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        .export-btn:hover {
            background: #218838;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .tab-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé´ Scanner Billets</h1>
            <p>Validez vos invitations</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('scan')">üì± Scanner</button>
            <button class="tab-btn" onclick="switchTab('results')">üìä R√©sultats</button>
            <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Config</button>
        </div>

        <!-- ONGLET SCAN -->
        <div id="scan" class="tab-content active">
            <div id="message" class="message"></div>

            <div id="cameraContainer">
                <video id="video" playsinline></video>
                <canvas id="canvas"></canvas>
            </div>

            <div class="camera-controls">
                <button class="btn btn-primary" onclick="startCamera()">üì∑ D√©marrer cam√©ra</button>
                <button class="btn btn-secondary" onclick="stopCamera()">‚èπÔ∏è Arr√™ter</button>
            </div>

            <p style="text-align: center; color: #666; font-size: 0.9em;">
                Positionnez le QR code devant la cam√©ra
            </p>
        </div>

        <!-- ONGLET R√âSULTATS -->
        <div id="results" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalScanned">0</h3>
                    <p>Scann√©s</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalDuplicate">0</h3>
                    <p>Doublons</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalInvalid">0</h3>
                    <p>Invalides</p>
                </div>
            </div>

            <div class="scanned-list" id="scannedList">
                <p style="text-align: center; color: #999;">Aucun scan pour le moment</p>
            </div>

            <button class="export-btn" onclick="exportJSON()">üíæ Exporter JSON</button>
        </div>

        <!-- ONGLET CONFIG -->
        <div id="config" class="tab-content">
            <h3>Configuration</h3>
            <p style="margin-top: 15px; margin-bottom: 10px;">
                <strong>Chemin fichier tickets_data.json:</strong>
            </p>
            <input 
                type="text" 
                id="dataFilePath" 
                placeholder="event_20250124/tickets_data.json"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;"
            >

            <button class="btn btn-primary" onclick="loadTicketData()" style="width: 100%;">
                üìÇ Charger donn√©es
            </button>

            <div id="configMessage" style="margin-top: 15px;"></div>

            <p style="margin-top: 20px; color: #666; font-size: 0.9em;">
                <strong>Instructions:</strong><br>
                1. G√©n√©rez les billets avec le script Python<br>
                2. Collez le chemin du fichier tickets_data.json<br>
                3. Cliquez sur "Charger donn√©es"<br>
                4. Allez √† l'onglet "Scanner" et validez les invitations
            </p>

            <button class="btn btn-secondary" onclick="clearAllData()" style="width: 100%; margin-top: 15px;">
                üóëÔ∏è Effacer tout
            </button>
        </div>
    </div>

    <script>
        let ticketsData = {};
        let scannedCodes = {};
        let videoRunning = false;

        // ============= DONN√âES DES BILLETS (√Ä METTRE √Ä JOUR) =============
        // Copiez tout le contenu de votre fichier tickets_data.json ici
        const TICKETS_DATA_EMBEDDED = {
  "09ea35f8-8f4c-41b7-8592-d1fe8c9778fa": {
    "id": "09ea35f8-8f4c-41b7-8592-d1fe8c9778fa",
    "nom": "MONSIEUR ETCHOME HENRI BLAISE ET MADAME",
    "table": 1,
    "table_name": "Excellence",
    "generated_at": "2025-12-27T21:58:39.300086"
  },
  "07d0b2fd-691e-4897-9e65-4900d15248df": {
    "id": "07d0b2fd-691e-4897-9e65-4900d15248df",
    "nom": "MADEMOISELLE DIELE AUDREY KHAREL",
    "table": 1,
    "table_name": "Excellence",
    "generated_at": "2025-12-27T21:58:40.877444"
  },
  "8b1c4f64-813a-4b55-a05b-ef51a4f7e2c8": {
    "id": "8b1c4f64-813a-4b55-a05b-ef51a4f7e2c8",
    "nom": "MADAME NGANDO JACQUIS",
    "table": 1,
    "table_name": "Excellence",
    "generated_at": "2025-12-27T21:58:42.312544"
  },
  "05b85e39-c638-4fff-88d8-fd36c6be8eee": {
    "id": "05b85e39-c638-4fff-88d8-fd36c6be8eee",
    "nom": "MADAME VEUVE EPOUNDE CHARLOTTE",
    "table": 1,
    "table_name": "Excellence",
    "generated_at": "2025-12-27T21:58:43.788805"
  },
  "4497a763-3e37-4a75-98b0-33d4587346bf": {
    "id": "4497a763-3e37-4a75-98b0-33d4587346bf",
    "nom": "MADAME VEUVE MISSE CELESTINE",
    "table": 1,
    "table_name": "Excellence",
    "generated_at": "2025-12-27T21:58:45.274392"
  },
  "3cdc0c8b-6b0f-49e9-9e42-65e489fe2d5f": {
    "id": "3cdc0c8b-6b0f-49e9-9e42-65e489fe2d5f",
    "nom": "MONSIEUR ANEURIN MBUGE ET MADAME",
    "table": 1,
    "table_name": "Excellence",
    "generated_at": "2025-12-27T21:58:46.944395"
  },
  "4fea7aca-5f1d-427e-98f8-288185566a4d": {
    "id": "4fea7aca-5f1d-427e-98f8-288185566a4d",
    "nom": "SISTER CAROLINE (VOPS)",
    "table": 1,
    "table_name": "Excellence",
    "generated_at": "2025-12-27T21:58:48.633670"
  },
  "2f533e34-a7e8-4077-b7a6-961926777902": {
    "id": "2f533e34-a7e8-4077-b7a6-961926777902",
    "nom": "SA MAJESTE EBANG PAUL",
    "table": 1,
    "table_name": "Excellence",
    "generated_at": "2025-12-27T21:58:50.098742"
  },
  "afa23147-2809-46d5-83bb-31bc3c7dcda6": {
    "id": "afa23147-2809-46d5-83bb-31bc3c7dcda6",
    "nom": "MONSIEUR DOH JEROME PENBAGA ET MADAME",
    "table": 2,
    "table_name": "Honneur",
    "generated_at": "2025-12-27T21:58:51.527104"
  },
  "166e79d5-1242-445b-9036-cf703d10f941": {
    "id": "166e79d5-1242-445b-9036-cf703d10f941",
    "nom": "MONSIEUR FONGOD EDWIN ET MADAME",
    "table": 2,
    "table_name": "Honneur",
    "generated_at": "2025-12-27T21:58:52.960225"
  },
  "d18c1b99-dc7e-4af9-b009-32940e1a9362": {
    "id": "d18c1b99-dc7e-4af9-b009-32940e1a9362",
    "nom": "SENATOR WANLO ET MADAME",
    "table": 2,
    "table_name": "Honneur",
    "generated_at": "2025-12-27T21:58:54.508099"
  },
  "a48c5661-695f-4a6f-b2a1-3bac2bb2af63": {
    "id": "a48c5661-695f-4a6f-b2a1-3bac2bb2af63",
    "nom": "MONSIEUR MPOLOMENA BLAISE ET MADAME",
    "table": 2,
    "table_name": "Honneur",
    "generated_at": "2025-12-27T21:58:56.131959"
  },
  "ee683755-9893-4e38-b30b-8a03c297fb04": {
    "id": "ee683755-9893-4e38-b30b-8a03c297fb04",
    "nom": "MONSIEUR TAM PATRICE ET MADAME",
    "table": 2,
    "table_name": "Honneur",
    "generated_at": "2025-12-27T21:58:57.857609"
  },
  "3eba4e88-4d1c-484c-8520-20b4e4f9d31b": {
    "id": "3eba4e88-4d1c-484c-8520-20b4e4f9d31b",
    "nom": "MADAME KEBILA NYONGLEMA SAMA HENSLA ET MONSIEUR",
    "table": 2,
    "table_name": "Honneur",
    "generated_at": "2025-12-27T21:58:59.531795"
  }
};
        
        // Charger les donn√©es depuis localStorage
        function loadFromStorage() {
            const stored = localStorage.getItem('scannedCodes');
            const storedTickets = localStorage.getItem('ticketsData');
            if (stored) scannedCodes = JSON.parse(stored);
            if (storedTickets) ticketsData = JSON.parse(storedTickets);
            else if (Object.keys(TICKETS_DATA_EMBEDDED).length > 0) {
                ticketsData = TICKETS_DATA_EMBEDDED;
                saveToStorage();
            }
            updateStats();
            updateScannedList();
        }

        // Sauvegarder dans localStorage
        function saveToStorage() {
            localStorage.setItem('scannedCodes', JSON.stringify(scannedCodes));
            localStorage.setItem('ticketsData', JSON.stringify(ticketsData));
        }

        // Charger les donn√©es de tickets
        async function loadTicketData() {
            const filePath = document.getElementById('dataFilePath').value;
            const configMsg = document.getElementById('configMessage');

            if (!filePath) {
                configMsg.innerHTML = '<div class="message error">‚ùå Veuillez entrer le chemin du fichier</div>';
                return;
            }

            try {
                const response = await fetch(filePath);
                if (!response.ok) throw new Error('Fichier non trouv√©');
                
                ticketsData = await response.json();
                saveToStorage();
                
                configMsg.innerHTML = `<div class="message success">‚úÖ ${Object.keys(ticketsData).length} billets charg√©s avec succ√®s!</div>`;
            } catch (error) {
                configMsg.innerHTML = `<div class="message error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // D√©marrer la cam√©ra
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // Attendre que la vid√©o soit pr√™te avant de scanner
                video.onloadedmetadata = () => {
                    video.play();
                    videoRunning = true;
                    scanQRCode();
                };
            } catch (error) {
                showMessage('‚ùå Erreur cam√©ra: ' + error.message, 'error');
            }
        }

        // Arr√™ter la cam√©ra
        function stopCamera() {
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            videoRunning = false;
        }

        // Scanner les QR codes
        function scanQRCode() {
            if (!videoRunning) return;

            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            // Attendre que la vid√©o soit pr√™te
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                if (videoRunning) {
                    requestAnimationFrame(scanQRCode);
                }
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            try {
                ctx.drawImage(video, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    processQRCode(code.data);
                }
            } catch (error) {
                console.error('Erreur scan:', error);
            }

            if (videoRunning) {
                requestAnimationFrame(scanQRCode);
            }
        }

        // Traiter le QR code scann√©
        function processQRCode(qrData) {
            // Parser le format: TABLE:1|INVITE:...|ID:...
            const match = qrData.match(/TABLE:(\d+)\|INVITE:(.+)\|ID:(.+)/);
            
            if (!match) {
                showMessage('‚ùå Format QR invalide', 'error');
                return;
            }

            const [, tableNum, inviteName, qrId] = match;
            const table = parseInt(tableNum);

            // V√©rifier si le ticket existe
            if (!ticketsData[qrId]) {
                showMessage('‚ùå Billet invalide ou inexistant', 'error');
                if (!scannedCodes[qrId]) {
                    scannedCodes[qrId] = {
                        id: qrId,
                        nom: 'INCONNU',
                        table: null,
                        timestamp_scan: new Date().toISOString(),
                        scanned_by: 'unknown',
                        status: 'invalid'
                    };
                    saveToStorage();
                }
                updateStats();
                return;
            }

            // V√©rifier les doublons
            if (scannedCodes[qrId]) {
                showMessage(`‚ö†Ô∏è D√âJ√Ä SCANN√â! ${inviteName} (Table ${table})`, 'warning');
                return;
            }

            // Enregistrer le scan
            scannedCodes[qrId] = {
                id: qrId,
                nom: inviteName,
                table: table,
                timestamp_scan: new Date().toISOString(),
                scanned_by: 'scanner_app',
                status: 'valid'
            };

            saveToStorage();
            showMessage(`‚úÖ Bienvenue ${inviteName}!\nTable: ${table}`, 'success');
            updateStats();
            updateScannedList();
        }

        // Afficher un message
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            setTimeout(() => {
                msg.className = 'message';
            }, 3000);
        }

        // Mettre √† jour les statistiques
        function updateStats() {
            const scans = Object.values(scannedCodes);
            const valid = scans.filter(s => s.status === 'valid').length;
            const invalid = scans.filter(s => s.status === 'invalid').length;

            document.getElementById('totalScanned').textContent = valid;
            document.getElementById('totalDuplicate').textContent = Object.keys(scannedCodes).length - valid - invalid;
            document.getElementById('totalInvalid').textContent = invalid;
        }

        // Mettre √† jour la liste des scann√©s
        function updateScannedList() {
            const list = document.getElementById('scannedList');
            const scans = Object.values(scannedCodes)
                .sort((a, b) => new Date(b.timestamp_scan) - new Date(a.timestamp_scan));

            if (scans.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">Aucun scan pour le moment</p>';
                return;
            }

            list.innerHTML = scans.map(scan => `
                <div class="scanned-item ${scan.status === 'invalid' ? 'duplicate' : ''}">
                    <h4>${scan.nom}</h4>
                    <p>
                        <span class="badge badge-table">Table ${scan.table}</span>
                        <span class="badge badge-time">${new Date(scan.timestamp_scan).toLocaleTimeString('fr-FR')}</span>
                    </p>
                    <p style="font-size: 0.85em; color: #999;">ID: ${scan.id.substring(0, 8)}...</p>
                </div>
            `).join('');
        }

        // Exporter en JSON
        function exportJSON() {
            const data = {
                timestamp: new Date().toISOString(),
                total_scans: Object.keys(scannedCodes).length,
                scans: Object.values(scannedCodes)
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scans_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Changer d'onglet
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Effacer toutes les donn√©es
        function clearAllData() {
            if (confirm('√ätes-vous s√ªr? Cela effacera tous les scans.')) {
                scannedCodes = {};
                localStorage.clear();
                updateStats();
                updateScannedList();
                showMessage('‚úÖ Donn√©es effac√©es', 'success');
            }
        }

        // Initialisation
        loadFromStorage();
        
        // Charger automatiquement les donn√©es au d√©marrage
        async function autoLoadData() {
            try {
                const response = await fetch('tickets_data.json');
                if (response.ok) {
                    ticketsData = await response.json();
                    saveToStorage();
                    console.log(`‚úÖ ${Object.keys(ticketsData).length} billets charg√©s automatiquement`);
                }
            } catch (error) {
                console.log('tickets_data.json non trouv√© - utilisez le formulaire pour charger');
            }
        }
        
        autoLoadData();
    </script>
</body>
</html>